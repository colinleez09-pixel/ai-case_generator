<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰ç«¯æ”¹è¿›åŠŸèƒ½ç»¼åˆæµ‹è¯•</title>
  <link rel="stylesheet" href="static/styles.css">
</head>
<body>
  <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
  <nav class="top-nav">
    <div class="nav-container">
      <div class="nav-brand">æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå¹³å°</div>
      <div class="nav-links">
        <a href="#" class="nav-link active">é¦–é¡µ</a>
        <a href="#" class="nav-link">ä½¿ç”¨æ–‡æ¡£</a>
        <a href="#" class="nav-link">æ›´æ–°æ—¥å¿—</a>
        <a href="#" class="nav-link">å¸®åŠ©ä¸­å¿ƒ</a>
      </div>
      <div class="nav-notice">
        <span class="notice-icon">ğŸ“¢</span>
        <span class="notice-text">æµ‹è¯•ï¼šå‰ç«¯æ”¹è¿›åŠŸèƒ½éªŒè¯</span>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- å¤´éƒ¨æ ‡é¢˜ -->
    <header class="header">
      <div class="header-text">
        <h1>å‰ç«¯æ”¹è¿›åŠŸèƒ½ç»¼åˆæµ‹è¯•</h1>
        <p>æµ‹è¯•å¯æŠ˜å è¯´æ˜ã€æ¶ˆæ¯æ—¶é—´æˆ³ã€å¯¹è¯æŒä¹…åŒ–å’Œé›†æˆä¸‹è½½åŠŸèƒ½</p>
      </div>
    </header>

    <!-- ä¸»ä½“å†…å®¹ -->
    <div class="main-content">
      <!-- å·¦ä¾§é…ç½®åŒº -->
      <div class="config-section">
        <!-- å¯æŠ˜å æ“ä½œè¯´æ˜ -->
        <div class="tips-card collapsible collapsed" id="instructionsCard">
          <div class="tips-header clickable" id="instructionsHeader">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="16" x2="12" y2="12"></line>
              <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span>æ“ä½œè¯´æ˜</span>
            <svg class="expand-icon" id="instructionsExpandIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </div>
          <div class="tips-content" id="instructionsContent">
            <ul class="tips-list">
              <li>1. æµ‹è¯•å¯æŠ˜å è¯´æ˜é¢æ¿åŠŸèƒ½</li>
              <li>2. æµ‹è¯•æ¶ˆæ¯æ—¶é—´æˆ³æ˜¾ç¤º</li>
              <li>3. æµ‹è¯•å¯¹è¯è®°å½•æŒä¹…åŒ–</li>
              <li>4. æµ‹è¯•é›†æˆä¸‹è½½å¡ç‰‡åŠŸèƒ½</li>
              <li>5. éªŒè¯æ‰€æœ‰åŠŸèƒ½ååŒå·¥ä½œ</li>
              <li>6. æ£€æŸ¥å“åº”å¼è®¾è®¡</li>
            </ul>
          </div>
        </div>

        <div class="card">
          <h3>æµ‹è¯•æ§åˆ¶é¢æ¿</h3>
          <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 16px;">
            <button id="testInstructions" class="action-btn primary">æµ‹è¯•è¯´æ˜é¢æ¿</button>
            <button id="testTimestamps" class="action-btn primary">æµ‹è¯•æ—¶é—´æˆ³</button>
            <button id="testPersistence" class="action-btn primary">æµ‹è¯•å¯¹è¯æŒä¹…åŒ–</button>
            <button id="testDownload" class="action-btn primary">æµ‹è¯•ä¸‹è½½åŠŸèƒ½</button>
            <button id="testAll" class="action-btn success">è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
            <button id="clearChat" class="action-btn secondary">æ¸…ç©ºå¯¹è¯</button>
          </div>
        </div>
      </div>

      <!-- å³ä¾§èŠå¤©åŒº -->
      <div class="chat-section">
        <div class="card chat-card">
          <div class="chat-header">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>AI åŠ©æ‰‹å¯¹è¯ - åŠŸèƒ½æµ‹è¯•</span>
          </div>
          <div class="chat-messages" id="chatMessages">
            <!-- æµ‹è¯•æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
          </div>
          <div class="chat-input-area" id="chatInputArea">
            <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯æµ‹è¯•å¯¹è¯åŠŸèƒ½...">
            <button class="send-btn" id="sendBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    const API_BASE_URL = '/api';
    let currentSessionId = 'test-session-123';
    let currentFileId = 'test-file-456';
    let instructionsExpanded = false;
    let isFirstGeneration = true;
    let conversationHistory = [];
    
    const elements = {
      chatMessages: document.getElementById('chatMessages'),
      chatInput: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      chatInputArea: document.getElementById('chatInputArea'),
      instructionsCard: document.getElementById('instructionsCard'),
      instructionsHeader: document.getElementById('instructionsHeader'),
      instructionsContent: document.getElementById('instructionsContent'),
      instructionsExpandIcon: document.getElementById('instructionsExpandIcon')
    };

    // æ—¶é—´æˆ³æ ¼å¼åŒ–å‡½æ•°
    function formatTimestamp(date) {
      const now = new Date();
      const messageDate = new Date(date);
      
      const isSameDay = now.toDateString() === messageDate.toDateString();
      
      const hours = messageDate.getHours().toString().padStart(2, '0');
      const minutes = messageDate.getMinutes().toString().padStart(2, '0');
      const timeString = `${hours}:${minutes}`;
      
      if (isSameDay) {
        return timeString;
      } else {
        const month = (messageDate.getMonth() + 1).toString().padStart(2, '0');
        const day = messageDate.getDate().toString().padStart(2, '0');
        return `${month}-${day} ${timeString}`;
      }
    }

    // å¯æŠ˜å è¯´æ˜é¢æ¿åŠŸèƒ½
    function toggleInstructions() {
      instructionsExpanded = !instructionsExpanded;
      
      if (instructionsExpanded) {
        elements.instructionsCard.classList.remove('collapsed');
        elements.instructionsExpandIcon.style.transform = 'rotate(0deg)';
      } else {
        elements.instructionsCard.classList.add('collapsed');
        elements.instructionsExpandIcon.style.transform = 'rotate(-90deg)';
      }
      
      console.log('è¯´æ˜é¢æ¿çŠ¶æ€:', instructionsExpanded ? 'å±•å¼€' : 'æŠ˜å ');
    }

    function initializeInstructionsState() {
      // é»˜è®¤æŠ˜å çŠ¶æ€
      instructionsExpanded = false;
      elements.instructionsCard.classList.add('collapsed');
      elements.instructionsExpandIcon.style.transform = 'rotate(-90deg)';
    }

    // æ¶ˆæ¯åŠŸèƒ½
    function addMessage(text, type, timestamp = null) {
      const messageTime = timestamp || new Date();
      const messageDiv = document.createElement("div");
      messageDiv.className = `message ${type}-message`;
      messageDiv.innerHTML = `
        <div class="message-avatar">${type === "ai" ? "Agent" : "æˆ‘"}</div>
        <div class="message-content">
          <div class="message-text">${text.replace(/\n/g, "<br>")}</div>
          <div class="message-timestamp">${formatTimestamp(messageTime)}</div>
        </div>
      `;
      
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
      
      // ä¿å­˜åˆ°å¯¹è¯å†å²
      conversationHistory.push({
        text: text,
        type: type,
        timestamp: messageTime
      });
      
      return messageDiv;
    }

    function addSessionSeparator() {
      const separatorDiv = document.createElement("div");
      separatorDiv.className = "session-separator";
      separatorDiv.innerHTML = `
        <div class="separator-line"></div>
        <div class="separator-text">æ–°çš„ç”Ÿæˆä¼šè¯</div>
        <div class="separator-line"></div>
      `;
      elements.chatMessages.appendChild(separatorDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    // ä¸‹è½½åŠŸèƒ½
    function downloadFile() {
      if (!currentSessionId || !currentFileId) {
        addMessage("ä¸‹è½½ä¿¡æ¯ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ç”Ÿæˆç”¨ä¾‹æ–‡ä»¶ã€‚", "ai");
        return;
      }

      try {
        console.log('æ¨¡æ‹Ÿä¸‹è½½æ–‡ä»¶:', `test_cases_${new Date().toISOString().slice(0, 10)}.xml`);
        alert('æ¨¡æ‹Ÿä¸‹è½½æˆåŠŸï¼');
      } catch (error) {
        console.error('ä¸‹è½½å¤±è´¥:', error);
        addMessage("ä¸‹è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚", "ai");
      }
    }

    function createDownloadCard(fileName = null, fileSize = null) {
      const defaultFileName = fileName || `test_cases_${new Date().toISOString().slice(0, 10)}.xml`;
      const defaultFileSize = fileSize || "2.3 KB";
      
      return `
        <div class="download-card" id="downloadCard">
          <div class="download-card-header">
            <div class="download-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </div>
            <div class="download-info">
              <h4>æµ‹è¯•ç”¨ä¾‹æ–‡ä»¶å·²ç”Ÿæˆ</h4>
              <span class="file-details">${defaultFileName} (${defaultFileSize})</span>
            </div>
          </div>
          <button class="download-button" id="downloadFileBtn">
            <svg class="download-btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <span>ä¸‹è½½æ–‡ä»¶</span>
          </button>
        </div>
      `;
    }

    function addDownloadCard(fileName = null, fileSize = null) {
      const cardHtml = createDownloadCard(fileName, fileSize);
      
      const messageDiv = document.createElement("div");
      messageDiv.className = "message ai-message";
      messageDiv.innerHTML = `
        <div class="message-avatar">Agent</div>
        <div class="message-content">
          <div class="message-text">ç”¨ä¾‹æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼ç‚¹å‡»ä¸‹æ–¹å¡ç‰‡ä¸‹è½½æ–‡ä»¶ã€‚</div>
          <div class="message-timestamp">${formatTimestamp(new Date())}</div>
          ${cardHtml}
        </div>
      `;
      
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
      
      const downloadBtn = messageDiv.querySelector('#downloadFileBtn');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
          downloadFile();
          addMessage("æ–‡ä»¶ä¸‹è½½å·²å¼€å§‹ï¼", "ai");
        });
      }
      
      return messageDiv;
    }

    // æµ‹è¯•å‡½æ•°
    function testInstructions() {
      addMessage("å¼€å§‹æµ‹è¯•å¯æŠ˜å è¯´æ˜é¢æ¿åŠŸèƒ½...", "ai");
      
      setTimeout(() => {
        addMessage("è¯·è§‚å¯Ÿå·¦ä¾§è¯´æ˜é¢æ¿çš„æŠ˜å /å±•å¼€åŠŸèƒ½ã€‚ç‚¹å‡»è¯´æ˜é¢æ¿æ ‡é¢˜æ¥åˆ‡æ¢çŠ¶æ€ã€‚", "ai");
        
        // è‡ªåŠ¨æ¼”ç¤ºæŠ˜å /å±•å¼€
        setTimeout(() => {
          addMessage("è‡ªåŠ¨å±•å¼€è¯´æ˜é¢æ¿...", "ai");
          if (!instructionsExpanded) toggleInstructions();
        }, 2000);
        
        setTimeout(() => {
          addMessage("è‡ªåŠ¨æŠ˜å è¯´æ˜é¢æ¿...", "ai");
          if (instructionsExpanded) toggleInstructions();
        }, 4000);
        
        setTimeout(() => {
          addMessage("âœ… è¯´æ˜é¢æ¿åŠŸèƒ½æµ‹è¯•å®Œæˆï¼", "ai");
        }, 6000);
      }, 1000);
    }

    function testTimestamps() {
      addMessage("å¼€å§‹æµ‹è¯•æ¶ˆæ¯æ—¶é—´æˆ³åŠŸèƒ½...", "ai");
      
      // åˆ›å»ºä¸åŒæ—¶é—´çš„æ¶ˆæ¯æ¥æµ‹è¯•æ—¶é—´æˆ³æ ¼å¼
      setTimeout(() => {
        addMessage("è¿™æ˜¯å½“å‰æ—¶é—´çš„æ¶ˆæ¯", "ai");
      }, 500);
      
      setTimeout(() => {
        addMessage("è¿™æ˜¯ç”¨æˆ·æ¶ˆæ¯ç¤ºä¾‹", "user");
      }, 1000);
      
      setTimeout(() => {
        // æ¨¡æ‹Ÿä¸åŒæ—¥æœŸçš„æ¶ˆæ¯
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        addMessage("è¿™æ˜¯æ˜¨å¤©çš„æ¶ˆæ¯ï¼ˆæ¨¡æ‹Ÿï¼‰", "ai", yesterday);
      }, 1500);
      
      setTimeout(() => {
        addMessage("âœ… æ—¶é—´æˆ³åŠŸèƒ½æµ‹è¯•å®Œæˆï¼è¯·æ£€æŸ¥æ¯æ¡æ¶ˆæ¯éƒ½æ˜¾ç¤ºäº†æ­£ç¡®çš„æ—¶é—´æˆ³ã€‚", "ai");
      }, 2000);
    }

    function testPersistence() {
      addMessage("å¼€å§‹æµ‹è¯•å¯¹è¯æŒä¹…åŒ–åŠŸèƒ½...", "ai");
      
      setTimeout(() => {
        addMessage("æ¨¡æ‹Ÿç¬¬ä¸€æ¬¡ç”Ÿæˆä¼šè¯çš„æ¶ˆæ¯...", "ai");
      }, 500);
      
      setTimeout(() => {
        addMessage("ç°åœ¨æ¨¡æ‹Ÿå¼€å§‹ç¬¬äºŒæ¬¡ç”Ÿæˆï¼ˆä¿æŒå¯¹è¯å†å²ï¼‰...", "ai");
        addSessionSeparator();
      }, 1500);
      
      setTimeout(() => {
        addMessage("è¿™æ˜¯ç¬¬äºŒæ¬¡ç”Ÿæˆä¼šè¯çš„æ¶ˆæ¯ã€‚æ³¨æ„ä¹‹å‰çš„å¯¹è¯è®°å½•è¢«ä¿ç•™äº†ã€‚", "ai");
      }, 2500);
      
      setTimeout(() => {
        addMessage("âœ… å¯¹è¯æŒä¹…åŒ–åŠŸèƒ½æµ‹è¯•å®Œæˆï¼", "ai");
      }, 3500);
    }

    function testDownload() {
      addMessage("å¼€å§‹æµ‹è¯•é›†æˆä¸‹è½½åŠŸèƒ½...", "ai");
      
      setTimeout(() => {
        addMessage("æ¨¡æ‹Ÿç”¨ä¾‹ç”Ÿæˆå®Œæˆï¼Œæ˜¾ç¤ºä¸‹è½½å¡ç‰‡...", "ai");
      }, 500);
      
      setTimeout(() => {
        addDownloadCard();
      }, 1500);
      
      setTimeout(() => {
        addMessage("âœ… ä¸‹è½½åŠŸèƒ½æµ‹è¯•å®Œæˆï¼è¯·ç‚¹å‡»ä¸Šæ–¹ä¸‹è½½å¡ç‰‡æµ‹è¯•ä¸‹è½½åŠŸèƒ½ã€‚æ³¨æ„èŠå¤©è¾“å…¥æ¡†ä¿æŒå¯ç”¨ã€‚", "ai");
      }, 2500);
    }

    function testAll() {
      addMessage("ğŸš€ å¼€å§‹è¿è¡Œå…¨éƒ¨åŠŸèƒ½æµ‹è¯•...", "ai");
      
      setTimeout(() => testInstructions(), 1000);
      setTimeout(() => testTimestamps(), 8000);
      setTimeout(() => testPersistence(), 12000);
      setTimeout(() => testDownload(), 17000);
      
      setTimeout(() => {
        addMessage("ğŸ‰ æ‰€æœ‰åŠŸèƒ½æµ‹è¯•å®Œæˆï¼\n\næµ‹è¯•ç»“æœæ€»ç»“ï¼š\nâœ… å¯æŠ˜å è¯´æ˜é¢æ¿\nâœ… æ¶ˆæ¯æ—¶é—´æˆ³\nâœ… å¯¹è¯æŒä¹…åŒ–\nâœ… é›†æˆä¸‹è½½åŠŸèƒ½\n\næ‰€æœ‰åŠŸèƒ½éƒ½æ­£å¸¸å·¥ä½œï¼", "ai");
      }, 22000);
    }

    function clearChat() {
      elements.chatMessages.innerHTML = '';
      conversationHistory = [];
      addMessage("å¯¹è¯å·²æ¸…ç©ºï¼Œå¯ä»¥é‡æ–°å¼€å§‹æµ‹è¯•ã€‚", "ai");
    }

    // äº‹ä»¶ç›‘å¬å™¨
    elements.instructionsHeader.addEventListener('click', toggleInstructions);

    elements.sendBtn.addEventListener('click', function() {
      const message = elements.chatInput.value.trim();
      if (message) {
        addMessage(message, "user");
        elements.chatInput.value = '';
        
        setTimeout(() => {
          addMessage("æ”¶åˆ°æ‚¨çš„æ¶ˆæ¯ï¼š" + message, "ai");
        }, 500);
      }
    });

    elements.chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        elements.sendBtn.click();
      }
    });

    // æµ‹è¯•æŒ‰é’®äº‹ä»¶
    document.getElementById('testInstructions').addEventListener('click', testInstructions);
    document.getElementById('testTimestamps').addEventListener('click', testTimestamps);
    document.getElementById('testPersistence').addEventListener('click', testPersistence);
    document.getElementById('testDownload').addEventListener('click', testDownload);
    document.getElementById('testAll').addEventListener('click', testAll);
    document.getElementById('clearChat').addEventListener('click', clearChat);

    // åˆå§‹åŒ–
    window.addEventListener('load', function() {
      initializeInstructionsState();
      addMessage("æ¬¢è¿ä½¿ç”¨å‰ç«¯æ”¹è¿›åŠŸèƒ½ç»¼åˆæµ‹è¯•ï¼\n\næœ¬æµ‹è¯•éªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š\n1. å¯æŠ˜å æ“ä½œè¯´æ˜é¢æ¿\n2. æ¶ˆæ¯æ—¶é—´æˆ³æ˜¾ç¤º\n3. å¯¹è¯è®°å½•æŒä¹…åŒ–\n4. é›†æˆä¸‹è½½å¡ç‰‡åŠŸèƒ½\n\nè¯·ä½¿ç”¨å·¦ä¾§æ§åˆ¶é¢æ¿è¿›è¡Œæµ‹è¯•ï¼Œæˆ–ç‚¹å‡»"è¿è¡Œå…¨éƒ¨æµ‹è¯•"è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ã€‚", "ai");
    });
  </script>
</body>
</html>