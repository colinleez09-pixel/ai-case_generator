<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŒ‰é’®è°ƒè¯• - æœ€ç»ˆæµ‹è¯•</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .test-section {
      border: 1px solid #ddd;
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
      background: #fafafa;
    }
    .action-btn {
      padding: 10px 24px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: #5a7a9a;
      color: white;
      border: none;
      margin: 10px 5px;
    }
    .action-btn:hover {
      background: #4a6a8a;
    }
    .action-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .message {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }
    .message-avatar {
      min-width: 42px;
      height: 36px;
      padding: 0 8px;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
      background: linear-gradient(135deg, #5a7a9a 0%, #7a9ab8 100%);
      color: white;
    }
    .message-content {
      flex: none;
      max-width: 70%;
      background: #f8f9fa;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      color: #2c3e50;
    }
    .generate-action {
      margin-top: 12px;
    }
    .log {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
    }
    .status {
      padding: 8px 12px;
      border-radius: 4px;
      font-weight: bold;
      margin: 10px 0;
      border: 1px solid;
    }
    .status.success { 
      background: #d4edda; 
      color: #155724; 
      border-color: #c3e6cb;
    }
    .status.error { 
      background: #f8d7da; 
      color: #721c24; 
      border-color: #f5c6cb;
    }
    .status.warning { 
      background: #fff3cd; 
      color: #856404; 
      border-color: #ffeaa7;
    }
    .status.info { 
      background: #d1ecf1; 
      color: #0c5460; 
      border-color: #bee5eb;
    }
    .chat-area {
      min-height: 150px;
      border: 2px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      background: white;
      position: relative;
    }
    .highlight {
      background: yellow;
      padding: 2px 4px;
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ æŒ‰é’®ç‚¹å‡»è°ƒè¯• - æœ€ç»ˆæµ‹è¯•</h1>
    <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•å’Œè°ƒè¯•"å¼€å§‹ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹"æŒ‰é’®çš„ç‚¹å‡»é—®é¢˜ã€‚</p>
    
    <div class="test-section">
      <h3>ğŸ“‹ æµ‹è¯•æ­¥éª¤</h3>
      <ol>
        <li>ç‚¹å‡»"æ¨¡æ‹Ÿæ˜¾ç¤ºç”ŸæˆæŒ‰é’®"</li>
        <li>è§‚å¯ŸèŠå¤©åŒºåŸŸæ˜¯å¦å‡ºç°ç”ŸæˆæŒ‰é’®</li>
        <li>ç‚¹å‡»ç”ŸæˆæŒ‰é’®</li>
        <li>æŸ¥çœ‹è°ƒè¯•æ—¥å¿—ç¡®è®¤ç‚¹å‡»äº‹ä»¶æ˜¯å¦è§¦å‘</li>
      </ol>
    </div>
    
    <div class="test-section">
      <h3>ğŸ® æ§åˆ¶é¢æ¿</h3>
      <button class="action-btn" onclick="simulateShowGenerateButton()">æ¨¡æ‹Ÿæ˜¾ç¤ºç”ŸæˆæŒ‰é’®</button>
      <button class="action-btn" onclick="clearChatArea()">æ¸…ç©ºèŠå¤©åŒºåŸŸ</button>
      <button class="action-btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      <button class="action-btn" onclick="runDiagnostics()">è¿è¡Œè¯Šæ–­</button>
    </div>
    
    <div class="test-section">
      <h3>ğŸ’¬ èŠå¤©åŒºåŸŸï¼ˆæ¨¡æ‹Ÿï¼‰</h3>
      <div id="chatMessages" class="chat-area">
        <p style="color: #666; font-style: italic;">èŠå¤©æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>
      </div>
    </div>
    
    <div class="test-section">
      <h3>ğŸ“Š çŠ¶æ€ä¿¡æ¯</h3>
      <div id="statusInfo" class="status info">ç­‰å¾…æµ‹è¯•å¼€å§‹...</div>
    </div>
    
    <div class="test-section">
      <h3>ğŸ› è°ƒè¯•æ—¥å¿—</h3>
      <div class="log" id="debugLog">
        <div style="color: #666;">[ç­‰å¾…æ—¥å¿—è¾“å‡º...]</div>
      </div>
    </div>
  </div>

  <script>
    // æ¨¡æ‹Ÿå…¨å±€å˜é‡å’ŒçŠ¶æ€
    let isGenerating = false;
    let currentSessionId = 'debug-session-' + Date.now();
    const API_BASE_URL = '/api';
    
    // æ¨¡æ‹Ÿ elements å¯¹è±¡
    const elements = {
      chatMessages: null
    };
    
    // æµ‹è¯•è®¡æ•°å™¨
    let testCounter = 0;
    let buttonClickCount = 0;
    
    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logDiv = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      const typeIcon = {
        'info': 'â„¹ï¸',
        'success': 'âœ…',
        'error': 'âŒ',
        'warning': 'âš ï¸',
        'debug': 'ğŸ”'
      }[type] || 'â„¹ï¸';
      
      logDiv.innerHTML += `<div style="margin: 2px 0;">[${timestamp}] ${typeIcon} ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function clearLog() {
      document.getElementById('debugLog').innerHTML = '<div style="color: #666;">[æ—¥å¿—å·²æ¸…ç©º]</div>';
    }
    
    function clearChatArea() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '<p style="color: #666; font-style: italic;">èŠå¤©æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</p>';
      log('èŠå¤©åŒºåŸŸå·²æ¸…ç©º', 'info');
      updateStatus('èŠå¤©åŒºåŸŸå·²æ¸…ç©º', 'info');
    }
    
    function updateStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusInfo');
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }
    
    // æ¨¡æ‹Ÿ addMessage å‡½æ•°
    function addMessage(text, type) {
      log(`æ·»åŠ æ¶ˆæ¯: [${type}] ${text}`, 'debug');
    }
    
    // æ¨¡æ‹Ÿ startGeneratingCases å‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼‰
    async function startGeneratingCases() {
      buttonClickCount++;
      log(`ğŸš€ startGeneratingCases è¢«è°ƒç”¨ (ç¬¬${buttonClickCount}æ¬¡)`, 'success');
      log(`ğŸ“Š çŠ¶æ€æ£€æŸ¥:`, 'debug');
      log(`  - currentSessionId: ${currentSessionId}`, 'debug');
      log(`  - isGenerating: ${isGenerating}`, 'debug');
      log(`  - API_BASE_URL: ${API_BASE_URL}`, 'debug');
      
      updateStatus(`startGeneratingCases æ‰§è¡ŒæˆåŠŸ (ç¬¬${buttonClickCount}æ¬¡)`, 'success');
      
      if (!currentSessionId) {
        log('ä¼šè¯IDä¸å­˜åœ¨', 'error');
        alert("ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°å¼€å§‹");
        return;
      }

      if (isGenerating) {
        log('å·²ç»åœ¨ç”Ÿæˆä¸­ï¼Œå¿½ç•¥è¯·æ±‚', 'warning');
        return;
      }

      log('è®¾ç½®ç”ŸæˆçŠ¶æ€ä¸º true', 'info');
      isGenerating = true;
      
      // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
      setTimeout(() => {
        log('æ¨¡æ‹Ÿç”Ÿæˆå®Œæˆ', 'success');
        isGenerating = false;
        updateStatus('ç”Ÿæˆå®Œæˆ', 'success');
      }, 2000);
    }
    
    // å®Œå…¨æ¨¡æ‹Ÿ showGenerateButton å‡½æ•°ï¼ˆæœ€ç»ˆç‰ˆæœ¬ï¼‰
    function simulateShowGenerateButton() {
      testCounter++;
      log(`ğŸ”„ å¼€å§‹ç¬¬${testCounter}æ¬¡æµ‹è¯•`, 'info');
      log('simulateShowGenerateButton è¢«è°ƒç”¨', 'debug');
      
      // æ›´æ–°çŠ¶æ€
      updateStatus(`æ­£åœ¨æ‰§è¡Œç¬¬${testCounter}æ¬¡æµ‹è¯•...`, 'warning');
      
      // æ£€æŸ¥å¿…è¦çš„å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!elements.chatMessages) {
        log('chatMessages å…ƒç´ ä¸å­˜åœ¨ï¼Œå°è¯•è·å–', 'warning');
        elements.chatMessages = document.getElementById("chatMessages");
        if (!elements.chatMessages) {
          log('æ— æ³•æ‰¾åˆ° chatMessages å…ƒç´ ', 'error');
          updateStatus('æµ‹è¯•å¤±è´¥ï¼šæ— æ³•æ‰¾åˆ°èŠå¤©åŒºåŸŸ', 'error');
          return;
        }
        log('æˆåŠŸè·å– chatMessages å…ƒç´ ', 'success');
      }
      
      log('å‡†å¤‡åˆ›å»ºæŒ‰é’®HTML', 'debug');
      const buttonHtml = `
        <div class="generate-action">
          <button class="action-btn primary" id="startGenerateBtn">å¼€å§‹ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</button>
        </div>
      `;
      
      const messageDiv = document.createElement("div");
      messageDiv.className = "message ai-message";
      messageDiv.innerHTML = `
        <div class="message-avatar">Agent</div>
        <div class="message-content">
          <p>æµ‹è¯•ç”¨ä¾‹åˆ†æå®Œæˆï¼ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ç”Ÿæˆã€‚</p>
          ${buttonHtml}
        </div>
      `;
      
      log('å‡†å¤‡æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ', 'debug');
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
      log('æ¶ˆæ¯å·²æ·»åŠ åˆ°èŠå¤©åŒºåŸŸ', 'success');

      // ä½¿ç”¨å¤šç§æ–¹å¼è·å–æŒ‰é’®å…ƒç´ 
      const startBtn1 = document.getElementById('startGenerateBtn');
      const startBtn2 = messageDiv.querySelector('#startGenerateBtn');
      const startBtn3 = elements.chatMessages.querySelector('#startGenerateBtn');
      
      log(`æŒ‰é’®æŸ¥æ‰¾ç»“æœ:`, 'debug');
      log(`  - getElementById: ${startBtn1 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`, 'debug');
      log(`  - messageDiv.querySelector: ${startBtn2 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`, 'debug');
      log(`  - chatMessages.querySelector: ${startBtn3 ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'}`, 'debug');
      
      const startBtn = startBtn1 || startBtn2 || startBtn3;
      
      if (startBtn) {
        log('æŒ‰é’®å…ƒç´ å­˜åœ¨ï¼Œå¼€å§‹ç»‘å®šäº‹ä»¶', 'success');
        
        // æ£€æŸ¥æŒ‰é’®å±æ€§
        log(`æŒ‰é’®å±æ€§æ£€æŸ¥:`, 'debug');
        log(`  - id: ${startBtn.id}`, 'debug');
        log(`  - className: ${startBtn.className}`, 'debug');
        log(`  - disabled: ${startBtn.disabled}`, 'debug');
        log(`  - offsetParent: ${startBtn.offsetParent !== null ? 'å¯è§' : 'éšè—'}`, 'debug');
        
        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
        const newBtn = startBtn.cloneNode(true);
        startBtn.parentNode.replaceChild(newBtn, startBtn);
        log('å·²æ›¿æ¢æŒ‰é’®å…ƒç´ ä»¥æ¸…é™¤æ—§äº‹ä»¶', 'debug');
        
        newBtn.addEventListener('click', function(event) {
          log('ğŸ¯ æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼', 'success');
          log(`äº‹ä»¶è¯¦æƒ…:`, 'debug');
          log(`  - event.type: ${event.type}`, 'debug');
          log(`  - event.target: ${event.target.tagName}`, 'debug');
          log(`  - this.disabled: ${this.disabled}`, 'debug');
          log(`  - isGenerating: ${isGenerating}`, 'debug');
          
          event.preventDefault();
          event.stopPropagation();
          
          // é˜²æ­¢é‡å¤ç‚¹å‡»
          if (this.disabled || isGenerating) {
            log('æŒ‰é’®å·²ç¦ç”¨æˆ–æ­£åœ¨ç”Ÿæˆä¸­ï¼Œå¿½ç•¥ç‚¹å‡»', 'warning');
            return;
          }
          
          log('å¼€å§‹å¤„ç†æŒ‰é’®ç‚¹å‡»', 'info');
          
          // ç¦ç”¨æŒ‰é’®
          this.disabled = true;
          this.textContent = "ç”Ÿæˆä¸­...";
          log('æŒ‰é’®çŠ¶æ€å·²æ›´æ–°ä¸ºç”Ÿæˆä¸­', 'info');
          
          // è°ƒç”¨ç”Ÿæˆå‡½æ•°
          try {
            log('å‡†å¤‡è°ƒç”¨ startGeneratingCases', 'info');
            startGeneratingCases().catch(error => {
              log(`startGeneratingCases å¼‚æ­¥æ‰§è¡Œå¤±è´¥: ${error.message}`, 'error');
              // æ¢å¤æŒ‰é’®çŠ¶æ€
              this.disabled = false;
              this.textContent = "å¼€å§‹ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹";
              updateStatus('ç”Ÿæˆå¤±è´¥', 'error');
            });
          } catch (error) {
            log(`è°ƒç”¨ startGeneratingCases å¤±è´¥: ${error.message}`, 'error');
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            this.disabled = false;
            this.textContent = "å¼€å§‹ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹";
            updateStatus('ç”Ÿæˆå¤±è´¥', 'error');
          }
        });
        
        log('æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ', 'success');
        
        // éªŒè¯äº‹ä»¶ç»‘å®š
        setTimeout(() => {
          const verifyBtn = document.getElementById('startGenerateBtn');
          log('äº‹ä»¶ç»‘å®šéªŒè¯:', 'debug');
          log(`  - æŒ‰é’®å­˜åœ¨: ${verifyBtn ? 'æ˜¯' : 'å¦'}`, 'debug');
          log(`  - æŒ‰é’®å¯è§: ${verifyBtn && verifyBtn.offsetParent !== null ? 'æ˜¯' : 'å¦'}`, 'debug');
          log(`  - æŒ‰é’®ç¦ç”¨: ${verifyBtn ? verifyBtn.disabled : 'N/A'}`, 'debug');
          
          if (verifyBtn && verifyBtn.offsetParent !== null && !verifyBtn.disabled) {
            updateStatus('æµ‹è¯•å‡†å¤‡å®Œæˆï¼Œè¯·ç‚¹å‡»ç”ŸæˆæŒ‰é’®', 'success');
            log('âœ… æµ‹è¯•å‡†å¤‡å®Œæˆï¼ŒæŒ‰é’®å¯ä»¥ç‚¹å‡»', 'success');
          } else {
            updateStatus('æµ‹è¯•å‡†å¤‡å¤±è´¥ï¼ŒæŒ‰é’®ä¸å¯ç‚¹å‡»', 'error');
            log('âŒ æµ‹è¯•å‡†å¤‡å¤±è´¥ï¼ŒæŒ‰é’®å­˜åœ¨é—®é¢˜', 'error');
          }
        }, 100);
        
      } else {
        log('æœªæ‰¾åˆ°æŒ‰é’®å…ƒç´ ï¼', 'error');
        log(`DOM ç»“æ„: ${messageDiv.innerHTML}`, 'debug');
        updateStatus('æµ‹è¯•å¤±è´¥ï¼šæœªæ‰¾åˆ°æŒ‰é’®å…ƒç´ ', 'error');
      }
    }
    
    function runDiagnostics() {
      log('ğŸ” å¼€å§‹è¿è¡Œè¯Šæ–­...', 'info');
      
      // æ£€æŸ¥DOMå…ƒç´ 
      const chatMessages = document.getElementById('chatMessages');
      log(`chatMessages å…ƒç´ : ${chatMessages ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`, chatMessages ? 'success' : 'error');
      
      if (chatMessages) {
        log(`chatMessages å±æ€§:`, 'debug');
        log(`  - offsetParent: ${chatMessages.offsetParent !== null ? 'å¯è§' : 'éšè—'}`, 'debug');
        log(`  - clientHeight: ${chatMessages.clientHeight}px`, 'debug');
        log(`  - innerHTML length: ${chatMessages.innerHTML.length} å­—ç¬¦`, 'debug');
        log(`  - å­å…ƒç´ æ•°é‡: ${chatMessages.children.length}`, 'debug');
      }
      
      // æ£€æŸ¥å…¨å±€å˜é‡
      log('å…¨å±€å˜é‡çŠ¶æ€:', 'debug');
      log(`  - isGenerating: ${isGenerating}`, 'debug');
      log(`  - currentSessionId: ${currentSessionId}`, 'debug');
      log(`  - testCounter: ${testCounter}`, 'debug');
      log(`  - buttonClickCount: ${buttonClickCount}`, 'debug');
      
      // æ£€æŸ¥ç°æœ‰æŒ‰é’®
      const existingBtn = document.getElementById('startGenerateBtn');
      if (existingBtn) {
        log('å‘ç°ç°æœ‰ç”ŸæˆæŒ‰é’®:', 'info');
        log(`  - æŒ‰é’®æ–‡æœ¬: "${existingBtn.textContent}"`, 'debug');
        log(`  - æŒ‰é’®ç¦ç”¨: ${existingBtn.disabled}`, 'debug');
        log(`  - æŒ‰é’®å¯è§: ${existingBtn.offsetParent !== null}`, 'debug');
      } else {
        log('æœªå‘ç°ç°æœ‰ç”ŸæˆæŒ‰é’®', 'info');
      }
      
      updateStatus('è¯Šæ–­å®Œæˆï¼Œè¯·æŸ¥çœ‹æ—¥å¿—', 'info');
      log('ğŸ” è¯Šæ–­å®Œæˆ', 'success');
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ', 'success');
      
      // åˆå§‹åŒ– elements
      elements.chatMessages = document.getElementById('chatMessages');
      log(`åˆå§‹åŒ– elements.chatMessages: ${elements.chatMessages ? 'æˆåŠŸ' : 'å¤±è´¥'}`, elements.chatMessages ? 'success' : 'error');
      
      updateStatus('é¡µé¢å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•', 'info');
      
      // è‡ªåŠ¨è¿è¡Œä¸€æ¬¡è¯Šæ–­
      setTimeout(() => {
        runDiagnostics();
      }, 500);
    });
  </script>
</body>
</html>