<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>左侧按钮状态测试</title>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <div class="container">
        <h1>左侧按钮状态测试</h1>
        
        <div class="test-layout">
            <!-- 左侧模拟区域 -->
            <div class="left-panel">
                <h2>左侧上传区域</h2>
                <div class="upload-section">
                    <p>需要生成的用例文件：test_case.xml</p>
                    <p>接口文档版本：API v1.0</p>
                    <button id="generateBtn" class="action-btn primary">开始生成</button>
                </div>
                
                <div class="test-controls">
                    <h3>测试流程</h3>
                    <button onclick="step1StartGeneration()" class="action-btn secondary">
                        1. 开始生成（左侧按钮变为"生成中..."）
                    </button>
                    <button onclick="step2ShowChatButton()" class="action-btn secondary">
                        2. 显示聊天按钮（左侧按钮应保持"生成中..."）
                    </button>
                    <button onclick="step3CompleteGeneration()" class="action-btn secondary">
                        3. 完成生成（左侧按钮变为"开始生成"）
                    </button>
                    <button onclick="resetTest()" class="action-btn secondary">
                        重置测试
                    </button>
                </div>
            </div>
            
            <!-- 右侧聊天区域 -->
            <div class="right-panel">
                <h2>AI助手对话框</h2>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message ai-message">
                            <div class="message-avatar">Agent</div>
                            <div class="message-content">
                                <div class="message-text">我已经分析了您的用例模板，现在可以开始生成测试用例了。</div>
                                <div class="message-timestamp">12:00:00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="status-display">
            <h3>当前状态</h3>
            <div id="statusInfo">
                <p>左侧按钮状态：<span id="leftButtonStatus">开始生成 (可点击)</span></p>
                <p>对话按钮状态：<span id="chatButtonStatus">无按钮</span></p>
                <p>isGenerating：<span id="isGeneratingStatus">false</span></p>
                <p>生成阶段：<span id="generationPhase">未开始</span></p>
            </div>
        </div>
        
        <div class="expected-behavior">
            <h3>预期行为</h3>
            <ol>
                <li><strong>开始生成</strong>：左侧按钮变为"生成中..."并禁用</li>
                <li><strong>多轮对话</strong>：左侧按钮保持"生成中..."状态</li>
                <li><strong>显示聊天按钮</strong>：左侧按钮仍然保持"生成中..."状态</li>
                <li><strong>生成完成</strong>：左侧按钮变为"开始生成"并可点击</li>
            </ol>
        </div>
        
        <div class="debug-info">
            <h3>调试信息</h3>
            <div id="debugOutput"></div>
        </div>
    </div>

    <script src="static/script.js"></script>
    <script>
        // 模拟全局变量
        let currentSessionId = 'test_session_123';
        let isGenerating = false;
        let generationComplete = false;
        let canDownload = false;
        let currentFileId = null;
        let testCases = [];
        const API_BASE_URL = '/api';
        
        // 模拟API响应
        window.fetch = async function(url, options) {
            console.log('模拟API调用:', url, options);
            
            if (url.includes('/api/chat/send')) {
                return {
                    ok: true,
                    json: async () => ({
                        success: true,
                        ready_to_generate: true
                    })
                };
            }
            
            return { ok: false, status: 404 };
        };
        
        function step1StartGeneration() {
            updateDebugInfo('步骤1：开始生成');
            document.getElementById('generationPhase').textContent = '生成进行中';
            
            // 模拟开始生成的状态
            isGenerating = true;
            if (elements.generateBtn) {
                elements.generateBtn.disabled = true;
                elements.generateBtn.textContent = "生成中...";
            }
            
            updateStatusDisplay();
            updateDebugInfo('左侧按钮应该变为"生成中..."并禁用');
        }
        
        function step2ShowChatButton() {
            updateDebugInfo('步骤2：显示聊天按钮');
            document.getElementById('generationPhase').textContent = '显示聊天按钮';
            
            // 调用showGenerateButton，测试是否会错误重置左侧按钮
            showGenerateButton();
            
            updateStatusDisplay();
            updateDebugInfo('左侧按钮应该保持"生成中..."状态，不应该被重置');
        }
        
        function step3CompleteGeneration() {
            updateDebugInfo('步骤3：完成生成');
            document.getElementById('generationPhase').textContent = '生成完成';
            
            // 模拟生成完成
            updateAllGenerateButtonsToCompleted();
            
            updateStatusDisplay();
            updateDebugInfo('左侧按钮现在应该变为"开始生成"并可点击');
        }
        
        function resetTest() {
            updateDebugInfo('重置测试');
            document.getElementById('generationPhase').textContent = '未开始';
            
            // 重置所有状态
            resetAllStatesForNewGeneration();
            
            // 清空聊天中的按钮
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="message ai-message">
                    <div class="message-avatar">Agent</div>
                    <div class="message-content">
                        <div class="message-text">我已经分析了您的用例模板，现在可以开始生成测试用例了。</div>
                        <div class="message-timestamp">12:00:00</div>
                    </div>
                </div>
            `;
            
            updateStatusDisplay();
            updateDebugInfo('测试已重置');
        }
        
        function updateStatusDisplay() {
            // 更新左侧按钮状态显示
            const leftBtn = document.getElementById('generateBtn');
            if (leftBtn) {
                const leftStatus = `${leftBtn.textContent} (${leftBtn.disabled ? '禁用' : '可点击'})`;
                document.getElementById('leftButtonStatus').textContent = leftStatus;
            }
            
            // 更新对话按钮状态显示
            const chatBtns = document.querySelectorAll('#startGenerateBtn, [id^="startGenerateBtn_"]');
            if (chatBtns.length > 0) {
                const chatBtn = chatBtns[chatBtns.length - 1]; // 获取最新的按钮
                const chatStatus = `${chatBtn.textContent} (${chatBtn.disabled ? '禁用' : '可点击'})`;
                document.getElementById('chatButtonStatus').textContent = chatStatus;
            } else {
                document.getElementById('chatButtonStatus').textContent = '无按钮';
            }
            
            // 更新isGenerating状态
            document.getElementById('isGeneratingStatus').textContent = isGenerating.toString();
        }
        
        function updateDebugInfo(message) {
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }
        
        // 监听控制台日志
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            updateDebugInfo('LOG: ' + args.join(' '));
        };
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateDebugInfo('测试页面已加载');
            
            // 确保DOM元素存在
            if (!elements.chatMessages) {
                elements.chatMessages = document.getElementById('chatMessages');
            }
            if (!elements.generateBtn) {
                elements.generateBtn = document.getElementById('generateBtn');
            }
            
            updateStatusDisplay();
            
            // 定期更新状态显示
            setInterval(updateStatusDisplay, 1000);
        });
    </script>
    
    <style>
        .test-layout {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .left-panel, .right-panel {
            flex: 1;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .upload-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .test-controls {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
        }
        
        .test-controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            text-align: left;
        }
        
        .chat-container {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            height: 200px;
            overflow-y: auto;
        }
        
        .status-display {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        .status-display p {
            margin: 5px 0;
            font-family: monospace;
        }
        
        .expected-behavior {
            margin: 20px 0;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 8px;
        }
        
        .expected-behavior ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        #debugOutput {
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        #debugOutput div {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
        
        .action-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .action-btn.primary {
            background: #007bff;
            color: white;
        }
        
        .action-btn.secondary {
            background: #6c757d;
            color: white;
        }
        
        .action-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</body>
</html>