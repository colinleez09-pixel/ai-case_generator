<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå·¥å…· - Mockæ•°æ®æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #fafafa;
        }
        .step h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input[type="file"], select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .info {
            color: #3498db;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .chat-area {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            background: white;
            margin-bottom: 10px;
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        .user-message {
            background: #e3f2fd;
            text-align: right;
        }
        .ai-message {
            background: #f1f8e9;
        }
        .message-input {
            width: calc(100% - 80px);
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        .test-cases {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            background: white;
            max-height: 400px;
            overflow-y: auto;
        }
        .test-case {
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .test-case h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .component {
            background: #ecf0f1;
            padding: 5px 8px;
            margin: 2px;
            border-radius: 3px;
            font-size: 12px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– AIæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆå·¥å…· - Mockæ•°æ®æµ‹è¯•</h1>
        
        <!-- æ­¥éª¤1: æ–‡ä»¶ä¸Šä¼  -->
        <div class="step">
            <h3>ğŸ“ æ­¥éª¤1: ä¸Šä¼ æ–‡ä»¶å¹¶å¯åŠ¨ä»»åŠ¡</h3>
            <div class="form-group">
                <label for="caseTemplate">ç”¨ä¾‹æ¨¡æ¿æ–‡ä»¶ (å¿…éœ€):</label>
                <input type="file" id="caseTemplate" accept=".xml" required>
            </div>
            <div class="form-group">
                <label for="historyCase">å†å²ç”¨ä¾‹æ–‡ä»¶ (å¯é€‰):</label>
                <input type="file" id="historyCase" accept=".xml">
            </div>
            <div class="form-group">
                <label for="apiVersion">APIç‰ˆæœ¬:</label>
                <select id="apiVersion">
                    <option value="v1.0">v1.0</option>
                    <option value="v2.0" selected>v2.0</option>
                    <option value="v3.0">v3.0</option>
                </select>
            </div>
            <button onclick="startGeneration()">å¼€å§‹ä»»åŠ¡</button>
            <div id="step1Result"></div>
        </div>

        <!-- æ­¥éª¤2: å¯¹è¯äº¤äº’ -->
        <div class="step">
            <h3>ğŸ’¬ æ­¥éª¤2: å¯¹è¯äº¤äº’</h3>
            <div class="chat-area" id="chatArea"></div>
            <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥æ‚¨çš„éœ€æ±‚..." disabled>
            <button onclick="sendMessage()" id="sendBtn" disabled>å‘é€</button>
            <button onclick="quickGenerate()" id="quickGenBtn" disabled>å¿«é€Ÿç”Ÿæˆ</button>
            <div id="step2Result"></div>
        </div>

        <!-- æ­¥éª¤3: ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ -->
        <div class="step">
            <h3>ğŸ”„ æ­¥éª¤3: ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</h3>
            <button onclick="generateTestCases()" id="generateBtn" disabled>å¼€å§‹ç”Ÿæˆ</button>
            <div id="generationProgress"></div>
            <div class="test-cases" id="testCasesArea" style="display: none;"></div>
            <div id="step3Result"></div>
        </div>

        <!-- æ­¥éª¤4: ç¡®è®¤å¹¶ä¸‹è½½ -->
        <div class="step">
            <h3>ğŸ“„ æ­¥éª¤4: ç¡®è®¤å¹¶ä¸‹è½½æ–‡ä»¶</h3>
            <button onclick="finalizeGeneration()" id="finalizeBtn" disabled>ç¡®è®¤ç”Ÿæˆ</button>
            <button onclick="downloadFile()" id="downloadBtn" disabled>ä¸‹è½½æ–‡ä»¶</button>
            <div id="step4Result"></div>
        </div>

        <!-- æ—¥å¿—åŒºåŸŸ -->
        <div class="step">
            <h3>ğŸ“‹ æ“ä½œæ—¥å¿—</h3>
            <div class="log" id="logArea"></div>
            <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:5000';
        let sessionId = null;
        let fileId = null;
        let testCases = [];

        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logArea.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
        }

        function createTestXMLFile() {
            const content = `<?xml version="1.0" encoding="UTF-8"?>
<testcases>
    <testcase id="TC001" name="ç™»å½•åŠŸèƒ½æµ‹è¯•">
        <preconditions>
            <precondition>ç”¨æˆ·å·²æ³¨å†Œè´¦å·</precondition>
        </preconditions>
        <steps>
            <step>æ‰“å¼€ç™»å½•é¡µé¢</step>
            <step>è¾“å…¥ç”¨æˆ·åå’Œå¯†ç </step>
            <step>ç‚¹å‡»ç™»å½•æŒ‰é’®</step>
        </steps>
        <expected_results>
            <result>æˆåŠŸè·³è½¬åˆ°ç”¨æˆ·ä»ªè¡¨æ¿</result>
        </expected_results>
    </testcase>
</testcases>`;
            return new Blob([content], { type: 'application/xml' });
        }

        async function startGeneration() {
            try {
                log('å¼€å§‹å¯åŠ¨ç”Ÿæˆä»»åŠ¡...');
                
                const formData = new FormData();
                
                // è·å–æ–‡ä»¶
                const caseTemplateFile = document.getElementById('caseTemplate').files[0];
                if (!caseTemplateFile) {
                    // å¦‚æœæ²¡æœ‰é€‰æ‹©æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªæµ‹è¯•æ–‡ä»¶
                    const testFile = createTestXMLFile();
                    formData.append('case_template', testFile, 'test_template.xml');
                    log('ä½¿ç”¨é»˜è®¤æµ‹è¯•æ¨¡æ¿æ–‡ä»¶');
                } else {
                    formData.append('case_template', caseTemplateFile);
                    log(`ä½¿ç”¨ä¸Šä¼ çš„æ¨¡æ¿æ–‡ä»¶: ${caseTemplateFile.name}`);
                }

                const historyCaseFile = document.getElementById('historyCase').files[0];
                if (historyCaseFile) {
                    formData.append('history_case', historyCaseFile);
                    log(`ä½¿ç”¨å†å²ç”¨ä¾‹æ–‡ä»¶: ${historyCaseFile.name}`);
                }

                // æ·»åŠ é…ç½®
                const config = {
                    api_version: document.getElementById('apiVersion').value
                };
                formData.append('config', JSON.stringify(config));

                const response = await fetch(`${BASE_URL}/api/generation/start`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    sessionId = result.session_id;
                    log(`ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼ä¼šè¯ID: ${sessionId}`, 'success');
                    document.getElementById('step1Result').innerHTML = 
                        `<div class="success">âœ… ä»»åŠ¡å¯åŠ¨æˆåŠŸ<br>ä¼šè¯ID: ${sessionId}</div>`;
                    
                    // å¯ç”¨å¯¹è¯åŠŸèƒ½
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('quickGenBtn').disabled = false;
                    
                    // æ·»åŠ åˆå§‹AIæ¶ˆæ¯
                    addChatMessage('ai', 'æ–‡ä»¶åˆ†æå®Œæˆï¼è¯·æè¿°æ‚¨å¸Œæœ›ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹ç±»å‹å’Œæµ‹è¯•åœºæ™¯ã€‚');
                } else {
                    log(`ä»»åŠ¡å¯åŠ¨å¤±è´¥: ${result.message}`, 'error');
                    document.getElementById('step1Result').innerHTML = 
                        `<div class="error">âŒ ${result.message}</div>`;
                }
            } catch (error) {
                log(`å¯åŠ¨ä»»åŠ¡å¼‚å¸¸: ${error.message}`, 'error');
                document.getElementById('step1Result').innerHTML = 
                    `<div class="error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }

        function addChatMessage(role, message) {
            const chatArea = document.getElementById('chatArea');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}-message`;
            messageDiv.innerHTML = `<strong>${role === 'user' ? 'ç”¨æˆ·' : 'AI'}:</strong> ${message}`;
            chatArea.appendChild(messageDiv);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !sessionId) return;

            try {
                addChatMessage('user', message);
                messageInput.value = '';
                log(`å‘é€æ¶ˆæ¯: ${message}`);

                const response = await fetch(`${BASE_URL}/api/chat/send`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: message
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    addChatMessage('ai', result.message);
                    log(`AIå›å¤: ${result.message.substring(0, 50)}...`);
                    
                    if (result.ready_to_generate) {
                        log('ä¼šè¯å·²å‡†å¤‡å¥½ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ï¼', 'success');
                        document.getElementById('generateBtn').disabled = false;
                        document.getElementById('step2Result').innerHTML = 
                            '<div class="success">âœ… å·²å‡†å¤‡å¥½ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</div>';
                    }
                } else {
                    log(`å¯¹è¯å¤±è´¥: ${result.message}`, 'error');
                    addChatMessage('ai', 'æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·é‡è¯•ã€‚');
                }
            } catch (error) {
                log(`å‘é€æ¶ˆæ¯å¼‚å¸¸: ${error.message}`, 'error');
                addChatMessage('ai', 'ç½‘ç»œè¿æ¥å‡ºç°é—®é¢˜ï¼Œè¯·é‡è¯•ã€‚');
            }
        }

        function quickGenerate() {
            document.getElementById('messageInput').value = 'å¼€å§‹ç”Ÿæˆ';
            sendMessage();
        }

        // å›è½¦å‘é€æ¶ˆæ¯
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        async function generateTestCases() {
            if (!sessionId) return;

            try {
                log('å¼€å§‹ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹...');
                document.getElementById('generationProgress').innerHTML = 'ğŸ”„ æ­£åœ¨ç”Ÿæˆ...';

                const response = await fetch(`${BASE_URL}/api/generation/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                
                                if (data.type === 'progress') {
                                    const progressData = data.data;
                                    document.getElementById('generationProgress').innerHTML = 
                                        `ğŸ”„ ${progressData.message} (${progressData.progress}%)`;
                                    log(`ç”Ÿæˆè¿›åº¦: ${progressData.message} (${progressData.progress}%)`);
                                } else if (data.type === 'complete') {
                                    testCases = data.data.test_cases;
                                    log(`ç”Ÿæˆå®Œæˆï¼å…±ç”Ÿæˆ ${testCases.length} æ¡æµ‹è¯•ç”¨ä¾‹`, 'success');
                                    
                                    document.getElementById('generationProgress').innerHTML = 
                                        `âœ… ç”Ÿæˆå®Œæˆï¼å…± ${testCases.length} æ¡æµ‹è¯•ç”¨ä¾‹`;
                                    
                                    displayTestCases(testCases);
                                    document.getElementById('finalizeBtn').disabled = false;
                                    
                                    document.getElementById('step3Result').innerHTML = 
                                        `<div class="success">âœ… æˆåŠŸç”Ÿæˆ ${testCases.length} æ¡æµ‹è¯•ç”¨ä¾‹</div>`;
                                } else if (data.type === 'error') {
                                    log(`ç”Ÿæˆå¤±è´¥: ${data.data.message}`, 'error');
                                    document.getElementById('generationProgress').innerHTML = 
                                        `âŒ ç”Ÿæˆå¤±è´¥: ${data.data.message}`;
                                }
                            } catch (e) {
                                // å¿½ç•¥JSONè§£æé”™è¯¯
                            }
                        }
                    }
                }
            } catch (error) {
                log(`ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹å¼‚å¸¸: ${error.message}`, 'error');
                document.getElementById('generationProgress').innerHTML = 
                    `âŒ ç”Ÿæˆå¤±è´¥: ${error.message}`;
            }
        }

        function displayTestCases(cases) {
            const testCasesArea = document.getElementById('testCasesArea');
            testCasesArea.style.display = 'block';
            testCasesArea.innerHTML = '';

            cases.forEach((tc, index) => {
                const tcDiv = document.createElement('div');
                tcDiv.className = 'test-case';
                
                let componentsHtml = '';
                
                // æ˜¾ç¤ºé¢„ç½®æ¡ä»¶ç»„ä»¶
                tc.preconditions?.forEach(pre => {
                    pre.components?.forEach(comp => {
                        componentsHtml += `<span class="component">${comp.type}: ${comp.name}</span>`;
                    });
                });
                
                // æ˜¾ç¤ºæ­¥éª¤ç»„ä»¶
                tc.steps?.forEach(step => {
                    step.components?.forEach(comp => {
                        componentsHtml += `<span class="component">${comp.type}: ${comp.name}</span>`;
                    });
                });
                
                // æ˜¾ç¤ºé¢„æœŸç»“æœç»„ä»¶
                tc.expectedResults?.forEach(result => {
                    result.components?.forEach(comp => {
                        componentsHtml += `<span class="component">${comp.type}: ${comp.name}</span>`;
                    });
                });

                tcDiv.innerHTML = `
                    <h4>${tc.id}: ${tc.name}</h4>
                    <div>ç»„ä»¶: ${componentsHtml}</div>
                `;
                
                testCasesArea.appendChild(tcDiv);
            });
        }

        async function finalizeGeneration() {
            if (!sessionId || !testCases.length) return;

            try {
                log('ç¡®è®¤å¹¶ç”Ÿæˆæœ€ç»ˆæ–‡ä»¶...');

                const response = await fetch(`${BASE_URL}/api/generation/finalize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        test_cases: testCases
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    fileId = result.file_id;
                    log(`æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼æ–‡ä»¶ID: ${fileId}`, 'success');
                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('step4Result').innerHTML = 
                        `<div class="success">âœ… æ–‡ä»¶ç”ŸæˆæˆåŠŸ<br>æ–‡ä»¶ID: ${fileId}</div>`;
                } else {
                    log(`æ–‡ä»¶ç”Ÿæˆå¤±è´¥: ${result.message}`, 'error');
                    document.getElementById('step4Result').innerHTML = 
                        `<div class="error">âŒ ${result.message}</div>`;
                }
            } catch (error) {
                log(`ç¡®è®¤ç”Ÿæˆå¼‚å¸¸: ${error.message}`, 'error');
                document.getElementById('step4Result').innerHTML = 
                    `<div class="error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</div>`;
            }
        }

        async function downloadFile() {
            if (!sessionId || !fileId) return;

            try {
                log('å¼€å§‹ä¸‹è½½æ–‡ä»¶...');

                const response = await fetch(`${BASE_URL}/api/generation/download?session_id=${sessionId}&file_id=${fileId}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `test_cases_${sessionId.substring(0, 8)}.xml`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    log(`æ–‡ä»¶ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å¤§å°: ${blob.size} å­—èŠ‚`, 'success');
                    document.getElementById('step4Result').innerHTML += 
                        `<br><div class="success">âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸ (${blob.size} å­—èŠ‚)</div>`;
                } else {
                    const error = await response.text();
                    log(`æ–‡ä»¶ä¸‹è½½å¤±è´¥: ${error}`, 'error');
                }
            } catch (error) {
                log(`ä¸‹è½½æ–‡ä»¶å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•');
            log('æç¤ºï¼šå¦‚æœæ²¡æœ‰XMLæ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥ç‚¹å‡»"å¼€å§‹ä»»åŠ¡"ä½¿ç”¨é»˜è®¤æµ‹è¯•æ–‡ä»¶');
        };
    </script>
</body>
</html>