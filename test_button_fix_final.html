<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŒ‰é’®ä¿®å¤æµ‹è¯•</title>
    <link rel="stylesheet" href="static/styles.css">
</head>
<body>
    <div class="container">
        <h1>æŒ‰é’®ä¿®å¤æµ‹è¯•</h1>
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="message ai-message">
                    <div class="message-avatar">Agent</div>
                    <div class="message-content">
                        <div class="message-text">æµ‹è¯•ç¯å¢ƒå·²å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•ã€‚</div>
                        <div class="message-timestamp">12:00:00</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="test-controls">
            <button onclick="testShowGenerateButton()" class="action-btn primary">æ˜¾ç¤ºç”ŸæˆæŒ‰é’®</button>
            <button onclick="clearMessages()" class="action-btn secondary">æ¸…ç©ºæ¶ˆæ¯</button>
            <button onclick="resetState()" class="action-btn secondary">é‡ç½®çŠ¶æ€</button>
        </div>
        
        <div class="debug-info">
            <h3>è°ƒè¯•ä¿¡æ¯</h3>
            <div id="debugOutput"></div>
        </div>
    </div>

    <script src="static/script.js"></script>
    <script>
        // æ¨¡æ‹Ÿå¿…è¦çš„å…¨å±€å˜é‡
        let currentSessionId = 'test_session_123';
        let isGenerating = false;
        const API_BASE_URL = '/api';
        
        // æ¨¡æ‹Ÿåç«¯APIå“åº”
        window.fetch = async function(url, options) {
            console.log('æ¨¡æ‹ŸAPIè°ƒç”¨:', url, options);
            
            if (url.includes('/api/chat/send')) {
                return {
                    ok: true,
                    json: async () => ({
                        success: true,
                        ready_to_generate: true
                    })
                };
            }
            
            if (url.includes('/api/generation/generate')) {
                return {
                    ok: true,
                    body: {
                        getReader: () => ({
                            read: async () => {
                                // æ¨¡æ‹Ÿæµå¼å“åº”
                                await new Promise(resolve => setTimeout(resolve, 1000));
                                return {
                                    done: true,
                                    value: new TextEncoder().encode('data: {"type":"complete","data":{"test_cases":[{"name":"æµ‹è¯•ç”¨ä¾‹1","id":"tc_001"}]}}\n')
                                };
                            }
                        })
                    }
                };
            }
            
            return { ok: false, status: 404 };
        };
        
        function testShowGenerateButton() {
            console.log('ğŸ§ª å¼€å§‹æµ‹è¯•æ˜¾ç¤ºç”ŸæˆæŒ‰é’®');
            updateDebugInfo('å¼€å§‹æµ‹è¯•æ˜¾ç¤ºç”ŸæˆæŒ‰é’®...');
            
            // ç¡®ä¿DOMå…ƒç´ å­˜åœ¨
            if (!elements.chatMessages) {
                elements.chatMessages = document.getElementById('chatMessages');
            }
            
            showGenerateButton();
        }
        
        function clearMessages() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div class="message ai-message">
                    <div class="message-avatar">Agent</div>
                    <div class="message-content">
                        <div class="message-text">æ¶ˆæ¯å·²æ¸…ç©ºï¼Œå¯ä»¥é‡æ–°å¼€å§‹æµ‹è¯•ã€‚</div>
                        <div class="message-timestamp">${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
            updateDebugInfo('æ¶ˆæ¯å·²æ¸…ç©º');
        }
        
        function resetState() {
            isGenerating = false;
            currentSessionId = 'test_session_' + Math.random().toString(36).substr(2, 9);
            updateDebugInfo('çŠ¶æ€å·²é‡ç½®ï¼Œæ–°ä¼šè¯ID: ' + currentSessionId);
        }
        
        function updateDebugInfo(message) {
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
        }
        
        // ç›‘å¬æ§åˆ¶å°æ—¥å¿—
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            updateDebugInfo('LOG: ' + args.join(' '));
        };
        
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            updateDebugInfo('ERROR: ' + args.join(' '));
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateDebugInfo('æµ‹è¯•é¡µé¢å·²åŠ è½½');
            updateDebugInfo('å½“å‰ä¼šè¯ID: ' + currentSessionId);
            updateDebugInfo('isGenerating: ' + isGenerating);
        });
    </script>
    
    <style>
        .test-controls {
            margin: 20px 0;
            text-align: center;
        }
        
        .test-controls button {
            margin: 0 10px;
        }
        
        .debug-info {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
        }
        
        #debugOutput {
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        
        #debugOutput div {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #eee;
        }
    </style>
</body>
</html>