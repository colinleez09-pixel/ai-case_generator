<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>测试对话持久化</title>
  <link rel="stylesheet" href="static/styles.css">
</head>
<body>
  <div class="container">
    <div class="main-content">
      <div class="config-section">
        <div class="card">
          <h3>对话持久化测试</h3>
          <p>点击"开始生成"按钮测试对话持久化功能：</p>
          <ul>
            <li>第一次点击：清空对话，开始新对话</li>
            <li>第二次点击：保留历史对话，添加会话分隔符</li>
            <li>后续点击：继续保留历史，添加新会话标记</li>
          </ul>
          <button class="generate-btn" id="generateBtn">开始生成</button>
          <button class="action-btn secondary" id="clearBtn" style="margin-top: 10px; width: 100%;">清空对话</button>
        </div>
      </div>
      
      <div class="chat-section">
        <div class="card chat-card">
          <div class="chat-header">
            <span>对话持久化测试</span>
          </div>
          <div class="chat-messages" id="chatMessages">
            <!-- 消息将通过JavaScript动态添加 -->
          </div>
          <div class="chat-input-area">
            <input type="text" id="messageInput" placeholder="输入测试消息...">
            <button id="sendBtn">发送</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 模拟全局变量
    let isFirstGeneration = true;
    let generationCount = 0;

    // 时间戳格式化函数
    function formatTimestamp(date) {
      const now = new Date();
      const messageDate = new Date(date);
      
      const isSameDay = now.toDateString() === messageDate.toDateString();
      
      const hours = messageDate.getHours().toString().padStart(2, '0');
      const minutes = messageDate.getMinutes().toString().padStart(2, '0');
      const timeString = `${hours}:${minutes}`;
      
      if (isSameDay) {
        return timeString;
      } else {
        const month = (messageDate.getMonth() + 1).toString().padStart(2, '0');
        const day = messageDate.getDate().toString().padStart(2, '0');
        return `${month}-${day} ${timeString}`;
      }
    }

    function addMessage(text, type, timestamp = null) {
      const messageTimestamp = timestamp || new Date();
      const formattedTime = formatTimestamp(messageTimestamp);
      
      const messageDiv = document.createElement("div")
      messageDiv.className = `message ${type}-message`
      messageDiv.innerHTML = `
        <div class="message-avatar">${type === "ai" ? "Agent" : "我"}</div>
        <div class="message-content">
          <div class="message-text">${text.replace(/\n/g, "<br>")}</div>
          <div class="message-timestamp">${formattedTime}</div>
        </div>
      `
      document.getElementById('chatMessages').appendChild(messageDiv)
      document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight
    }

    function addSessionSeparator() {
      const separatorDiv = document.createElement("div");
      separatorDiv.className = "session-separator";
      separatorDiv.innerHTML = `
        <div class="separator-line"></div>
        <div class="separator-text">新会话开始</div>
        <div class="separator-line"></div>
      `;
      document.getElementById('chatMessages').appendChild(separatorDiv);
      document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
    }

    function clearConversation() {
      document.getElementById('chatMessages').innerHTML = '';
      isFirstGeneration = true;
      generationCount = 0;
    }

    function simulateGeneration() {
      generationCount++;
      
      if (isFirstGeneration) {
        // 第一次生成：清空聊天记录
        document.getElementById('chatMessages').innerHTML = '';
        addMessage("正在连接AI服务...", "ai");
        addMessage("文件上传成功，正在分析您的用例文件...", "ai");
        addMessage("我已经分析了您的用例模板。为了生成更准确的测试用例，请问：\n\n1. 这个系统主要的用户群体是谁？\n2. 是否有特殊的安全性要求？", "ai");
        isFirstGeneration = false;
      } else {
        // 后续生成：保留对话历史，添加会话分隔符
        addSessionSeparator();
        addMessage("开始新的生成会话...", "ai");
        addMessage(`这是第 ${generationCount} 次生成。之前的对话历史已保留。`, "ai");
        addMessage("请继续与我对话，测试对话持久化功能。", "ai");
      }
    }

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      // 初始消息
      addMessage("你好！我是 AI 测试用例生成助手。请点击左侧的\"开始生成\"按钮测试对话持久化功能。", "ai");

      // 绑定生成按钮
      document.getElementById('generateBtn').addEventListener('click', simulateGeneration);

      // 绑定清空按钮
      document.getElementById('clearBtn').addEventListener('click', clearConversation);

      // 绑定发送消息
      document.getElementById('sendBtn').addEventListener('click', function() {
        const input = document.getElementById('messageInput');
        if (input.value.trim()) {
          addMessage(input.value, "user");
          input.value = '';
          
          // 模拟AI回复
          setTimeout(() => {
            addMessage("收到你的消息。你可以继续测试对话持久化功能。", "ai");
          }, 500);
        }
      });

      // 回车发送
      document.getElementById('messageInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('sendBtn').click();
        }
      });
    });
  </script>
</body>
</html>