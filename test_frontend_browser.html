<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ç«¯Mockæ•°æ®æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 20px; margin: 5px; }
        #log { background: #f5f5f5; padding: 10px; height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>å‰ç«¯Mockæ•°æ®æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>æµ‹è¯•æ­¥éª¤</h2>
        <button onclick="testMockData()">å¼€å§‹æµ‹è¯•Mockæ•°æ®</button>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div class="test-section">
        <h2>æµ‹è¯•æ—¥å¿—</h2>
        <div id="log"></div>
    </div>

    <script>
        const API_BASE_URL = '/api';
        let testCases = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function testMockData() {
            log('ğŸ§ª å¼€å§‹æµ‹è¯•å‰ç«¯Mockæ•°æ®æ˜¾ç¤º', 'info');
            
            try {
                // 1. å¯åŠ¨ç”Ÿæˆä»»åŠ¡
                log('ğŸ“ æ­¥éª¤1: å¯åŠ¨ç”Ÿæˆä»»åŠ¡');
                
                const formData = new FormData();
                const testXml = `<?xml version="1.0" encoding="UTF-8"?>
<testcases>
    <testcase id="TC001" name="ç™»å½•æµ‹è¯•">
        <steps><step>æ‰“å¼€ç™»å½•é¡µé¢</step></steps>
    </testcase>
</testcases>`;
                
                const blob = new Blob([testXml], { type: 'application/xml' });
                formData.append('case_template', blob, 'test.xml');
                formData.append('config', JSON.stringify({ api_version: 'v1.0' }));
                
                const startResponse = await fetch(`${API_BASE_URL}/generation/start`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!startResponse.ok) {
                    throw new Error(`å¯åŠ¨å¤±è´¥: ${startResponse.status}`);
                }
                
                const startResult = await startResponse.json();
                const sessionId = startResult.session_id;
                log(`âœ… ä»»åŠ¡å¯åŠ¨æˆåŠŸï¼Œä¼šè¯ID: ${sessionId}`, 'success');
                
                // 2. å‘é€"å¼€å§‹ç”Ÿæˆ"æ¶ˆæ¯
                log('ğŸ’¬ æ­¥éª¤2: å‘é€å¼€å§‹ç”Ÿæˆæ¶ˆæ¯');
                
                const chatResponse = await fetch(`${API_BASE_URL}/chat/send`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: sessionId,
                        message: 'å¼€å§‹ç”Ÿæˆ'
                    })
                });
                
                if (!chatResponse.ok) {
                    throw new Error(`å¯¹è¯å¤±è´¥: ${chatResponse.status}`);
                }
                
                const chatResult = await chatResponse.json();
                log(`ğŸ¤– AIå›å¤: ${chatResult.message.substring(0, 50)}...`);
                log(`ğŸ“Š å‡†å¤‡ç”Ÿæˆ: ${chatResult.ready_to_generate}`, chatResult.ready_to_generate ? 'success' : 'info');
                
                // 3. ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
                log('ğŸ”„ æ­¥éª¤3: ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹');
                
                const genResponse = await fetch(`${API_BASE_URL}/generation/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: sessionId })
                });
                
                if (!genResponse.ok) {
                    throw new Error(`ç”Ÿæˆå¤±è´¥: ${genResponse.status}`);
                }
                
                // å¤„ç†æµå¼å“åº”
                const reader = genResponse.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let progressCount = 0;
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                
                                if (data.type === 'progress') {
                                    progressCount++;
                                    const progressData = data.data;
                                    log(`ğŸ“¦ è¿›åº¦ ${progressCount}: ${progressData.message} (${progressData.progress}%)`);
                                } else if (data.type === 'complete') {
                                    const completeData = data.data;
                                    testCases = completeData.test_cases || [];
                                    log(`ğŸ‰ ç”Ÿæˆå®Œæˆï¼å…±ç”Ÿæˆ ${testCases.length} æ¡æµ‹è¯•ç”¨ä¾‹`, 'success');
                                    
                                    // æ˜¾ç¤ºæµ‹è¯•ç”¨ä¾‹åˆ—è¡¨
                                    testCases.forEach((tc, index) => {
                                        log(`   ${index + 1}. ${tc.name} (ID: ${tc.id})`);
                                    });
                                    
                                    // éªŒè¯å…³é”®ä¿®å¤
                                    if (testCases.length > 0) {
                                        log('âœ… ä¿®å¤æˆåŠŸï¼å‰ç«¯ç°åœ¨èƒ½æ­£ç¡®æ˜¾ç¤ºæµ‹è¯•ç”¨ä¾‹æ•°é‡', 'success');
                                        log(`ğŸ’¡ ç”¨ä¾‹æ•°é‡æ˜¾ç¤º: å…± ${testCases.length} ä¸ªç”¨ä¾‹`, 'success');
                                    } else {
                                        log('âŒ ä»ç„¶æ²¡æœ‰æµ‹è¯•ç”¨ä¾‹æ•°æ®', 'error');
                                    }
                                    return;
                                } else if (data.type === 'error') {
                                    throw new Error(data.data.message || 'ç”Ÿæˆè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
                                }
                            } catch (e) {
                                log(`âš ï¸ è§£ææ•°æ®å¤±è´¥: ${e.message}`, 'error');
                            }
                        }
                    }
                }
                
            } catch (error) {
                log(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>