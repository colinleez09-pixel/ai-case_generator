<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>下载卡片功能测试</title>
  <link rel="stylesheet" href="static/styles.css">
</head>
<body>
  <div class="container">
    <h1>下载卡片功能测试</h1>
    
    <div class="main-content">
      <div class="chat-section">
        <div class="card chat-card">
          <div class="chat-header">
            <span>测试下载卡片功能</span>
          </div>
          <div class="chat-messages" id="chatMessages">
            <!-- 测试消息将在这里显示 -->
          </div>
          <div class="chat-input-area">
            <button id="testDownloadCard" class="action-btn primary">测试下载卡片</button>
            <button id="testDownloadClick" class="action-btn secondary">测试下载点击</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 模拟必要的全局变量和函数
    const API_BASE_URL = '/api';
    let currentSessionId = 'test-session-123';
    let currentFileId = 'test-file-456';
    
    const elements = {
      chatMessages: document.getElementById('chatMessages')
    };

    // 时间戳格式化函数
    function formatTimestamp(date) {
      const now = new Date();
      const messageDate = new Date(date);
      
      const isSameDay = now.toDateString() === messageDate.toDateString();
      
      const hours = messageDate.getHours().toString().padStart(2, '0');
      const minutes = messageDate.getMinutes().toString().padStart(2, '0');
      const timeString = `${hours}:${minutes}`;
      
      if (isSameDay) {
        return timeString;
      } else {
        const month = (messageDate.getMonth() + 1).toString().padStart(2, '0');
        const day = messageDate.getDate().toString().padStart(2, '0');
        return `${month}-${day} ${timeString}`;
      }
    }

    // 下载卡片相关函数
    function createDownloadCard(fileName = null, fileSize = null) {
      const defaultFileName = fileName || `test_cases_${new Date().toISOString().slice(0, 10)}.xml`;
      const defaultFileSize = fileSize || "2.3 KB";
      
      const downloadCardHtml = `
        <div class="download-card" id="downloadCard">
          <div class="download-card-header">
            <div class="download-icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
              </svg>
            </div>
            <div class="download-info">
              <h4>测试用例文件已生成</h4>
              <span class="file-details">${defaultFileName} (${defaultFileSize})</span>
            </div>
          </div>
          <button class="download-button" id="downloadFileBtn">
            <svg class="download-btn-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
              <polyline points="7 10 12 15 17 10"></polyline>
              <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            <span>下载文件</span>
          </button>
        </div>
      `;
      
      return downloadCardHtml;
    }

    function addDownloadCard(fileName = null, fileSize = null) {
      const cardHtml = createDownloadCard(fileName, fileSize);
      
      const messageDiv = document.createElement("div");
      messageDiv.className = "message ai-message";
      messageDiv.innerHTML = `
        <div class="message-avatar">Agent</div>
        <div class="message-content">
          <div class="message-text">用例文件生成完成！点击下方卡片下载文件。</div>
          <div class="message-timestamp">${formatTimestamp(new Date())}</div>
          ${cardHtml}
        </div>
      `;
      
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
      
      // 绑定下载按钮事件
      const downloadBtn = messageDiv.querySelector('#downloadFileBtn');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', handleDownloadClick);
      }
      
      return messageDiv;
    }

    function handleDownloadClick() {
      console.log('下载按钮被点击');
      alert('模拟下载：test_cases_2024-01-08.xml');
      showDownloadFeedback();
    }

    function showDownloadFeedback() {
      const feedbackDiv = document.createElement("div");
      feedbackDiv.className = "message ai-message";
      feedbackDiv.innerHTML = `
        <div class="message-avatar">Agent</div>
        <div class="message-content">
          <div class="message-text">文件下载已开始！</div>
          <div class="message-timestamp">${formatTimestamp(new Date())}</div>
        </div>
      `;
      
      elements.chatMessages.appendChild(feedbackDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    // 测试按钮事件
    document.getElementById('testDownloadCard').addEventListener('click', function() {
      addDownloadCard();
    });

    document.getElementById('testDownloadClick').addEventListener('click', function() {
      const existingCard = document.querySelector('#downloadFileBtn');
      if (existingCard) {
        existingCard.click();
      } else {
        alert('请先点击"测试下载卡片"按钮生成下载卡片');
      }
    });

    // 初始化时显示一条欢迎消息
    window.addEventListener('load', function() {
      const welcomeDiv = document.createElement("div");
      welcomeDiv.className = "message ai-message";
      welcomeDiv.innerHTML = `
        <div class="message-avatar">Agent</div>
        <div class="message-content">
          <div class="message-text">欢迎测试下载卡片功能！点击下方按钮进行测试。</div>
          <div class="message-timestamp">${formatTimestamp(new Date())}</div>
        </div>
      `;
      elements.chatMessages.appendChild(welcomeDiv);
    });
  </script>
</body>
</html>