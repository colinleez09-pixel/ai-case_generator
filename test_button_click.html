<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æŒ‰é’®ç‚¹å‡»æµ‹è¯• - å¢å¼ºç‰ˆ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .action-btn {
      padding: 10px 24px;
      font-size: 14px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      background: #5a7a9a;
      color: white;
      border: none;
      margin: 10px;
    }
    .action-btn:hover {
      background: #4a6a8a;
    }
    .action-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .message {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }
    .message-avatar {
      min-width: 42px;
      height: 36px;
      padding: 0 8px;
      border-radius: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
      background: linear-gradient(135deg, #5a7a9a 0%, #7a9ab8 100%);
      color: white;
    }
    .message-content {
      flex: none;
      max-width: 70%;
      background: #f8f9fa;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      color: #2c3e50;
    }
    .generate-action {
      margin-top: 12px;
    }
    .log {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .test-section {
      border: 1px solid #ddd;
      margin: 20px 0;
      padding: 15px;
      border-radius: 8px;
    }
    .status {
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: bold;
      margin: 5px 0;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.warning { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>æŒ‰é’®ç‚¹å‡»æµ‹è¯• - å¢å¼ºç‰ˆè°ƒè¯•</h1>
    
    <div class="test-section">
      <h3>æµ‹è¯•1: ç›´æ¥æŒ‰é’®</h3>
      <button class="action-btn primary" onclick="testClick1()">ç›´æ¥æŒ‰é’®æµ‹è¯•</button>
      <div id="status1" class="status"></div>
    </div>
    
    <div class="test-section">
      <h3>æµ‹è¯•2: åŠ¨æ€åˆ›å»ºçš„æŒ‰é’®ï¼ˆæ¨¡æ‹Ÿå®é™…æƒ…å†µï¼‰</h3>
      <div id="dynamicButtonContainer"></div>
      <button onclick="createDynamicButton()">åˆ›å»ºåŠ¨æ€æŒ‰é’®</button>
      <div id="status2" class="status"></div>
    </div>
    
    <div class="test-section">
      <h3>æµ‹è¯•3: å®Œå…¨æ¨¡æ‹ŸshowGenerateButtonï¼ˆå¢å¼ºç‰ˆï¼‰</h3>
      <div id="chatMessages" style="min-height: 100px; border: 1px solid #ddd; padding: 10px; border-radius: 4px;"></div>
      <button onclick="simulateShowGenerateButton()">æ¨¡æ‹Ÿæ˜¾ç¤ºç”ŸæˆæŒ‰é’®</button>
      <button onclick="clearChatMessages()">æ¸…ç©ºèŠå¤©åŒºåŸŸ</button>
      <div id="status3" class="status"></div>
    </div>
    
    <div class="test-section">
      <h3>æµ‹è¯•4: å…ƒç´ æ£€æŸ¥</h3>
      <button onclick="checkElements()">æ£€æŸ¥DOMå…ƒç´ </button>
      <div id="status4" class="status"></div>
    </div>
    
    <h3>è°ƒè¯•æ—¥å¿—</h3>
    <div class="log" id="debugLog"></div>
    
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    <button onclick="runAllTests()">è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
  </div>

  <script>
    // æ¨¡æ‹Ÿå…¨å±€å˜é‡
    let isGenerating = false;
    let currentSessionId = 'test-session-123';
    const API_BASE_URL = '/api';
    
    // æ¨¡æ‹Ÿ elements å¯¹è±¡
    const elements = {
      chatMessages: null
    };
    
    function log(message) {
      const logDiv = document.getElementById('debugLog');
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }
    
    function clearLog() {
      document.getElementById('debugLog').innerHTML = '';
    }
    
    function clearChatMessages() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '';
      log('èŠå¤©åŒºåŸŸå·²æ¸…ç©º');
    }
    
    function setStatus(testId, message, type = 'success') {
      const statusDiv = document.getElementById(`status${testId}`);
      statusDiv.textContent = message;
      statusDiv.className = `status ${type}`;
    }
    
    function testClick1() {
      log('âœ… ç›´æ¥æŒ‰é’®ç‚¹å‡»æˆåŠŸ!');
      setStatus(1, 'ç›´æ¥æŒ‰é’®æµ‹è¯•é€šè¿‡');
    }
    
    function createDynamicButton() {
      log('åˆ›å»ºåŠ¨æ€æŒ‰é’®...');
      const container = document.getElementById('dynamicButtonContainer');
      container.innerHTML = '<button class="action-btn primary" id="dynamicBtn">åŠ¨æ€æŒ‰é’®</button>';
      
      const btn = document.getElementById('dynamicBtn');
      if (btn) {
        btn.addEventListener('click', function() {
          log('âœ… åŠ¨æ€æŒ‰é’®ç‚¹å‡»æˆåŠŸ!');
          setStatus(2, 'åŠ¨æ€æŒ‰é’®æµ‹è¯•é€šè¿‡');
        });
        log('åŠ¨æ€æŒ‰é’®åˆ›å»ºå®Œæˆ');
        setStatus(2, 'åŠ¨æ€æŒ‰é’®å·²åˆ›å»ºï¼Œè¯·ç‚¹å‡»æµ‹è¯•');
      } else {
        log('âŒ åŠ¨æ€æŒ‰é’®åˆ›å»ºå¤±è´¥');
        setStatus(2, 'åŠ¨æ€æŒ‰é’®åˆ›å»ºå¤±è´¥', 'error');
      }
    }
    
    function checkElements() {
      log('ğŸ” æ£€æŸ¥DOMå…ƒç´ ...');
      
      const chatMessages = document.getElementById('chatMessages');
      log('chatMessages å…ƒç´ : ' + (chatMessages ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
      
      if (chatMessages) {
        log('chatMessages å±æ€§:');
        log('  - offsetParent: ' + (chatMessages.offsetParent !== null ? 'å¯è§' : 'éšè—'));
        log('  - clientHeight: ' + chatMessages.clientHeight);
        log('  - innerHTML length: ' + chatMessages.innerHTML.length);
      }
      
      elements.chatMessages = chatMessages;
      log('elements.chatMessages å·²æ›´æ–°');
      
      setStatus(4, 'DOMå…ƒç´ æ£€æŸ¥å®Œæˆ');
    }
    
    // æ¨¡æ‹Ÿ addMessage å‡½æ•°
    function addMessage(text, type) {
      log(`ğŸ“ æ·»åŠ æ¶ˆæ¯: [${type}] ${text}`);
      // è¿™é‡Œä¸å®é™…æ·»åŠ æ¶ˆæ¯ï¼Œåªæ˜¯è®°å½•æ—¥å¿—
    }
    
    // æ¨¡æ‹Ÿ startGeneratingCases å‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼‰
    async function startGeneratingCases() {
      log('ğŸš€ startGeneratingCases å‡½æ•°è¢«è°ƒç”¨');
      log('ğŸ“Š å½“å‰çŠ¶æ€æ£€æŸ¥:');
      log('  - currentSessionId: ' + currentSessionId);
      log('  - isGenerating: ' + isGenerating);
      log('  - API_BASE_URL: ' + API_BASE_URL);
      
      if (!currentSessionId) {
        log('âŒ ä¼šè¯IDä¸å­˜åœ¨');
        alert("ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°å¼€å§‹");
        return;
      }

      if (isGenerating) {
        log('âš ï¸ å·²ç»åœ¨ç”Ÿæˆä¸­ï¼Œå¿½ç•¥è¯·æ±‚');
        return;
      }

      log('âœ… è®¾ç½®ç”ŸæˆçŠ¶æ€ä¸º true');
      isGenerating = true;
      
      // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
      setTimeout(() => {
        log('âœ… æ¨¡æ‹Ÿç”Ÿæˆå®Œæˆ');
        isGenerating = false;
        setStatus(3, 'startGeneratingCases æ‰§è¡ŒæˆåŠŸ');
      }, 2000);
    }
    
    // å®Œå…¨æ¨¡æ‹Ÿ showGenerateButton å‡½æ•°ï¼ˆå¢å¼ºç‰ˆï¼‰
    function simulateShowGenerateButton() {
      log('ğŸ”„ simulateShowGenerateButton è¢«è°ƒç”¨');
      log('elements.chatMessages:', elements.chatMessages);
      log('currentSessionId:', currentSessionId);
      log('isGenerating:', isGenerating);
      
      // æ£€æŸ¥å¿…è¦çš„å…ƒç´ æ˜¯å¦å­˜åœ¨
      if (!elements.chatMessages) {
        log('chatMessages å…ƒç´ ä¸å­˜åœ¨ï¼Œå°è¯•é‡æ–°è·å–');
        elements.chatMessages = document.getElementById("chatMessages");
        if (!elements.chatMessages) {
          log('âŒ æ— æ³•æ‰¾åˆ° chatMessages å…ƒç´ ');
          setStatus(3, 'æ— æ³•æ‰¾åˆ° chatMessages å…ƒç´ ', 'error');
          return;
        }
      }
      
      const buttonHtml = `
        <div class="generate-action">
          <button class="action-btn primary" id="startGenerateBtn">å¼€å§‹ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹</button>
        </div>
      `;
      
      const messageDiv = document.createElement("div");
      messageDiv.className = "message ai-message";
      messageDiv.innerHTML = `
        <div class="message-avatar">Agent</div>
        <div class="message-content">${buttonHtml}</div>
      `;
      
      log('å‡†å¤‡æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ');
      elements.chatMessages.appendChild(messageDiv);
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
      log('æ¶ˆæ¯å·²æ·»åŠ åˆ°èŠå¤©åŒºåŸŸ');

      // ä½¿ç”¨æ›´å¯é çš„æ–¹å¼è·å–æŒ‰é’®å…ƒç´ 
      const startBtn = document.getElementById('startGenerateBtn');
      log('é€šè¿‡IDæŸ¥æ‰¾æŒ‰é’®å…ƒç´ : ' + (startBtn ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'));
      
      if (!startBtn) {
        // å¦‚æœé€šè¿‡IDæ‰¾ä¸åˆ°ï¼Œå°è¯•é€šè¿‡querySelector
        const startBtnAlt = messageDiv.querySelector('#startGenerateBtn');
        log('é€šè¿‡querySelectoræŸ¥æ‰¾æŒ‰é’®å…ƒç´ : ' + (startBtnAlt ? 'æ‰¾åˆ°' : 'æœªæ‰¾åˆ°'));
      }
      
      if (startBtn) {
        log('æŒ‰é’®å…ƒç´ å­˜åœ¨ï¼Œå¼€å§‹ç»‘å®šäº‹ä»¶');
        
        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
        const newBtn = startBtn.cloneNode(true);
        startBtn.parentNode.replaceChild(newBtn, startBtn);
        
        newBtn.addEventListener('click', function(event) {
          log('ğŸ¯ æŒ‰é’®è¢«ç‚¹å‡»äº†!');
          log('äº‹ä»¶å¯¹è±¡: ' + (event ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
          log('æŒ‰é’®å…ƒç´ : ' + (this ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'));
          log('æŒ‰é’®çŠ¶æ€ - disabled: ' + this.disabled);
          log('å…¨å±€çŠ¶æ€ - isGenerating: ' + isGenerating);
          
          event.preventDefault();
          event.stopPropagation();
          
          // é˜²æ­¢é‡å¤ç‚¹å‡»
          if (this.disabled || isGenerating) {
            log('âš ï¸ æŒ‰é’®å·²ç¦ç”¨æˆ–æ­£åœ¨ç”Ÿæˆä¸­ï¼Œå¿½ç•¥ç‚¹å‡»');
            return;
          }
          
          log('âœ… å¼€å§‹å¤„ç†æŒ‰é’®ç‚¹å‡»');
          
          // ç¦ç”¨æŒ‰é’®
          this.disabled = true;
          this.textContent = "ç”Ÿæˆä¸­...";
          log('æŒ‰é’®çŠ¶æ€å·²æ›´æ–°ä¸ºç”Ÿæˆä¸­');
          
          // è°ƒç”¨ç”Ÿæˆå‡½æ•°
          try {
            log('ğŸ“ å‡†å¤‡è°ƒç”¨ startGeneratingCases');
            startGeneratingCases().catch(error => {
              log('startGeneratingCases å¼‚æ­¥æ‰§è¡Œå¤±è´¥: ' + error.message);
              // æ¢å¤æŒ‰é’®çŠ¶æ€
              this.disabled = false;
              this.textContent = "å¼€å§‹ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹";
            });
          } catch (error) {
            log('âŒ è°ƒç”¨ startGeneratingCases å¤±è´¥: ' + error.message);
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            this.disabled = false;
            this.textContent = "å¼€å§‹ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹";
          }
        });
        
        log('âœ… æŒ‰é’®äº‹ä»¶ç»‘å®šå®Œæˆ');
        
        // éªŒè¯äº‹ä»¶ç»‘å®š
        setTimeout(() => {
          log('éªŒè¯æŒ‰é’®çŠ¶æ€:');
          const btn = document.getElementById('startGenerateBtn');
          log('- æŒ‰é’®æ˜¯å¦å­˜åœ¨: ' + (btn ? 'æ˜¯' : 'å¦'));
          log('- æŒ‰é’®æ˜¯å¦å¯è§: ' + (btn && btn.offsetParent !== null ? 'æ˜¯' : 'å¦'));
          log('- æŒ‰é’®æ˜¯å¦ç¦ç”¨: ' + (btn ? btn.disabled : 'N/A'));
          
          setStatus(3, 'ç”ŸæˆæŒ‰é’®å·²åˆ›å»ºï¼Œè¯·ç‚¹å‡»æµ‹è¯•', 'warning');
        }, 100);
        
      } else {
        log('âŒ æœªæ‰¾åˆ°æŒ‰é’®å…ƒç´ !');
        log('DOM ç»“æ„: ' + messageDiv.innerHTML);
        setStatus(3, 'æœªæ‰¾åˆ°æŒ‰é’®å…ƒç´ ', 'error');
      }
    }
    
    function runAllTests() {
      log('ğŸ§ª å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
      
      // é‡ç½®çŠ¶æ€
      clearLog();
      isGenerating = false;
      
      // è¿è¡Œæµ‹è¯•
      setTimeout(() => {
        log('æµ‹è¯•1: ç›´æ¥æŒ‰é’®');
        testClick1();
      }, 100);
      
      setTimeout(() => {
        log('æµ‹è¯•2: åŠ¨æ€æŒ‰é’®');
        createDynamicButton();
      }, 200);
      
      setTimeout(() => {
        log('æµ‹è¯•3: å…ƒç´ æ£€æŸ¥');
        checkElements();
      }, 300);
      
      setTimeout(() => {
        log('æµ‹è¯•4: æ¨¡æ‹Ÿç”ŸæˆæŒ‰é’®');
        simulateShowGenerateButton();
      }, 400);
    }
    
    // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ');
      checkElements();
    });
  </script>
</body>
</html>