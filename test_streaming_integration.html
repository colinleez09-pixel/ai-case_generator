<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµå¼èŠå¤©é›†æˆæµ‹è¯•</title>
    <link rel="stylesheet" href="static/styles.css">
    <style>
        body {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #2c3e50;
        }
        
        .test-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 8px 16px;
            background: #5a7a9a;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.15s ease;
        }
        
        .test-btn:hover {
            background: #4a6a8a;
            transform: translateY(-1px);
        }
        
        .test-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-display {
            background: #f8f9fa;
            border: 1px solid #e8ecef;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 16px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .chat-container {
            border: 1px solid #e8ecef;
            border-radius: 8px;
            height: 400px;
            overflow-y: auto;
            padding: 16px;
            background: #f8f9fa;
        }
        
        .input-container {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .message-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #e8ecef;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .send-btn {
            padding: 8px 16px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .send-btn:hover {
            background: #229954;
        }
        
        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-title">ğŸ§ª æµå¼èŠå¤©é›†æˆæµ‹è¯•</div>
        
        <div class="test-controls">
            <button class="test-btn" onclick="testStreamingSupport()">æ£€æŸ¥æµå¼æ”¯æŒ</button>
            <button class="test-btn" onclick="testStreamingMessage()">æµ‹è¯•æµå¼æ¶ˆæ¯</button>
            <button class="test-btn" onclick="testErrorHandling()">æµ‹è¯•é”™è¯¯å¤„ç†</button>
            <button class="test-btn" onclick="clearChat()">æ¸…ç©ºèŠå¤©</button>
        </div>
        
        <div class="status-display" id="statusDisplay">
            å‡†å¤‡å°±ç»ª - ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•
        </div>
        
        <div class="chat-container" id="chatMessages">
            <!-- èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>
        
        <div class="input-container">
            <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯..." />
            <button class="send-btn" id="sendBtn" onclick="sendTestMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿå…¨å±€å˜é‡
        let currentSessionId = 'test_session_' + Date.now();
        let globalStreamingDisplay = null;
        const API_BASE_URL = '/api';
        
        // æ¨¡æ‹Ÿ elements å¯¹è±¡
        const elements = {
            chatMessages: document.getElementById('chatMessages')
        };
        
        // çŠ¶æ€æ˜¾ç¤º
        function updateStatus(message, type = 'info') {
            const statusDisplay = document.getElementById('statusDisplay');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            statusDisplay.textContent = `[${timestamp}] ${typeIcon} ${message}`;
        }
        
        // æ—¶é—´æˆ³æ ¼å¼åŒ–å‡½æ•°
        function formatTimestamp(date) {
            const now = new Date();
            const messageDate = new Date(date);
            
            const isSameDay = now.toDateString() === messageDate.toDateString();
            
            const hours = messageDate.getHours().toString().padStart(2, '0');
            const minutes = messageDate.getMinutes().toString().padStart(2, '0');
            const timeString = `${hours}:${minutes}`;
            
            if (isSameDay) {
                return timeString;
            } else {
                const month = (messageDate.getMonth() + 1).toString().padStart(2, '0');
                const day = messageDate.getDate().toString().padStart(2, '0');
                return `${month}-${day} ${timeString}`;
            }
        }
    </script>
    
    <!-- å¼•å…¥æµå¼æ¶ˆæ¯æ˜¾ç¤ºç±» -->
    <script src="static/script.js"></script>
    
    <script>
        // æµ‹è¯•å‡½æ•°
        async function testStreamingSupport() {
            updateStatus('æ£€æŸ¥æµå¼APIæ”¯æŒ...');
            
            try {
                const response = await fetch(`${API_BASE_URL}/chat/streaming/support`);
                const result = await response.json();
                
                if (result.success && result.supported) {
                    updateStatus('æµå¼APIæ”¯æŒæ£€æŸ¥æˆåŠŸ', 'success');
                } else {
                    updateStatus('æµå¼APIä¸æ”¯æŒ', 'error');
                }
            } catch (error) {
                updateStatus(`æµå¼APIæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testStreamingMessage() {
            updateStatus('æµ‹è¯•æµå¼æ¶ˆæ¯æ˜¾ç¤º...');
            
            // åˆ›å»ºæµå¼æ¶ˆæ¯æ˜¾ç¤º
            const streamingDisplay = new StreamingMessageDisplay("chatMessages", {
                typingSpeed: 60,
                cursorBlinkRate: 500,
                autoScroll: true,
                showCursor: true,
                allowSkip: true
            });
            
            const messageId = streamingDisplay.startStreaming();
            updateStatus(`å¼€å§‹æµå¼æ˜¾ç¤º: ${messageId}`, 'success');
            
            // æ¨¡æ‹Ÿé€æ­¥æ·»åŠ æ–‡æœ¬
            const testText = "è¿™æ˜¯ä¸€ä¸ªæµå¼æ¶ˆæ¯æ˜¾ç¤ºæµ‹è¯•ã€‚æˆ‘ä¼šé€å­—æ˜¾ç¤ºè¿™æ®µæ–‡æœ¬ï¼Œå±•ç¤ºæ‰“å­—æœºæ•ˆæœã€‚æ‚¨å¯ä»¥ä½¿ç”¨æ§åˆ¶æŒ‰é’®æ¥æš‚åœã€æ¢å¤æˆ–è·³è¿‡åŠ¨ç”»ã€‚";
            
            let index = 0;
            const addChar = () => {
                if (index < testText.length) {
                    streamingDisplay.appendText(testText[index]);
                    index++;
                    setTimeout(addChar, 50 + Math.random() * 50); // éšæœºé—´éš”æ¨¡æ‹ŸçœŸå®æµå¼
                } else {
                    setTimeout(() => {
                        streamingDisplay.finishStreaming();
                        updateStatus('æµå¼æ¶ˆæ¯æ˜¾ç¤ºå®Œæˆ', 'success');
                    }, 1000);
                }
            };
            
            setTimeout(addChar, 500);
        }
        
        async function testErrorHandling() {
            updateStatus('æµ‹è¯•é”™è¯¯å¤„ç†...');
            
            // åˆ›å»ºæµå¼æ¶ˆæ¯æ˜¾ç¤º
            const streamingDisplay = new StreamingMessageDisplay("chatMessages", {
                typingSpeed: 80,
                cursorBlinkRate: 500,
                autoScroll: true,
                showCursor: true,
                allowSkip: true
            });
            
            const messageId = streamingDisplay.startStreaming();
            
            // æ¨¡æ‹Ÿéƒ¨åˆ†æ¶ˆæ¯åå‡ºé”™
            streamingDisplay.appendText("æ­£åœ¨å¤„ç†æ‚¨çš„è¯·æ±‚");
            
            setTimeout(() => {
                streamingDisplay.appendText("ï¼Œé‡åˆ°äº†ä¸€äº›é—®é¢˜");
                setTimeout(() => {
                    streamingDisplay.finishStreaming();
                    
                    // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                    addMessage("æŠ±æ­‰ï¼Œå¤„ç†è¿‡ç¨‹ä¸­é‡åˆ°ç½‘ç»œå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•ã€‚", "ai");
                    updateStatus('é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ', 'success');
                }, 1000);
            }, 2000);
        }
        
        async function sendTestMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                updateStatus('è¯·è¾“å…¥æµ‹è¯•æ¶ˆæ¯', 'error');
                return;
            }
            
            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(message, "user");
            messageInput.value = '';
            
            updateStatus('å‘é€æµ‹è¯•æ¶ˆæ¯...');
            
            try {
                // æ£€æŸ¥æ˜¯å¦æ”¯æŒæµå¼API
                const supportsStreaming = await checkStreamingSupport();
                
                if (supportsStreaming) {
                    updateStatus('ä½¿ç”¨æµå¼APIå¤„ç†æ¶ˆæ¯', 'success');
                    await handleStreamingChat(message);
                } else {
                    updateStatus('ä½¿ç”¨æ™®é€šAPIå¤„ç†æ¶ˆæ¯');
                    await handleRegularChat(message);
                }
                
            } catch (error) {
                updateStatus(`æ¶ˆæ¯å‘é€å¤±è´¥: ${error.message}`, 'error');
                addMessage(`å‘é€å¤±è´¥: ${error.message}`, "ai");
            }
        }
        
        function clearChat() {
            const chatContainer = document.getElementById('chatMessages');
            chatContainer.innerHTML = '';
            updateStatus('èŠå¤©è®°å½•å·²æ¸…ç©º');
        }
        
        // é”®ç›˜äº‹ä»¶
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendTestMessage();
            }
        });
        
        // åˆå§‹åŒ–
        updateStatus('æµå¼èŠå¤©é›†æˆæµ‹è¯•é¡µé¢å·²åŠ è½½');
    </script>
</body>
</html>